---
title: "ä»é›¶åˆ°ä¸€ï¼šæˆ‘åœ¨Flutterä¸­æ„å»ºEPUBé˜…è¯»å™¨çš„è¶Ÿå‘å®å½•"
date: 2025-08-29
author: "qqaazz2"
cover: /assets/images/dreader-logo.png
tags: [Flutter, Dart, EPUB, è‡ªå®šä¹‰æ¸²æŸ“,Dreader]
star: true
category:
  - Dreader
---

## å‰è¨€

ä½œä¸ºä¸€ä¸ªå°è¯´çˆ±å¥½è€…ï¼Œé˜…è¯»å¯¹æˆ‘æ¥è¯´ä¸ä»…æ˜¯æ‰“å‘æ—¶é—´ï¼Œæ›´æ˜¯ä¸€ç§èƒ½è®©æˆ‘æ²‰æµ¸åœ¨å¦ä¸€ä¸ªä¸–ç•Œé‡Œçš„æ–¹å¼ã€‚æ¯æ¬¡ç¿»é¡µï¼Œéƒ½åƒæ˜¯çŸ­æš‚åœ°é€ƒç¦»ç°å®ï¼ŒæŠ•å…¥åˆ°æ–‡å­—ç¼–ç»‡çš„ä¸–ç•Œé‡Œã€‚  

æ­£å› ä¸ºè¿™æ ·ï¼Œæˆ‘çªç„¶æœ‰äº†ä¸ªæƒ³æ³•ï¼š**ä¸ºä»€ä¹ˆä¸è‡ªå·±åŠ¨æ‰‹åšä¸€ä¸ªä¸“å±çš„ EPUB é˜…è¯»å™¨å‘¢ï¼Ÿ**  

è¿™æ ·ä¸ä»…èƒ½é¡ºä¾¿æ·±å…¥ç ”ç©¶ä¸€ä¸‹ Flutter çš„æ¸²æŸ“æœºåˆ¶ï¼Œè¿˜èƒ½ç»™è‡ªå·±æ‰“é€ ä¸€ä¸ªå®Œå…¨å±äºæˆ‘çš„é˜…è¯»ç©ºé—´ã€‚å¸¦ç€è¿™æ ·çš„å¿µå¤´ï¼Œæˆ‘å°±å¼€å§‹äº†è¿™æ®µæ—¢æœ‰æŒ‘æˆ˜åˆå……æ»¡ä¹è¶£çš„æ—…ç¨‹ã€‚  

ä»æœ€å¼€å§‹çš„ä¸€ä¸ªå°å°å¿µå¤´ï¼Œåˆ°ä¸€æ­¥æ­¥æŠŠåŠŸèƒ½åšå‡ºæ¥ï¼Œæœ€ç»ˆæœ‰äº† DReader â€”â€” ä¸€ä¸ªç®€æ˜“çš„ EPUB é˜…è¯»å™¨ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œå®ƒä¸ä»…ä»…æ˜¯ä¸ªé¡¹ç›®ï¼Œæ›´æ˜¯æˆ‘æŠŠå¯¹é˜…è¯»çš„çƒ­çˆ±å’ŒæŠ€æœ¯æ¢ç´¢ç»“åˆåœ¨ä¸€èµ·çš„æˆæœã€‚

## æŠ€æœ¯é€‰å‹

åœ¨é¡¹ç›®åˆæœŸï¼Œæˆ‘å°è¯•äº†å¤šç§é’ˆå¯¹è¯¥EPUBä¹¦ç±çš„æ¸²æŸ“æ–¹æ¡ˆï¼Œæ¯ç§æ–¹æ¡ˆéƒ½å…·å¤‡å…¶ç‹¬ç‰¹çš„ä¼˜åŠ¿ã€‚

### æ–¹æ¡ˆä¸€ï¼šæå–æ–‡æœ¬ï¼Œè‡ªè¡Œæ’ç‰ˆ

- æˆ‘çš„åˆè¡·æ˜¯å°† EPUB æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–‡æœ¬æå–å‡ºæ¥ï¼Œäº¤ç”± Flutter é‡æ–°è®¡ç®—æ’ç‰ˆï¼Œå¹¶å¯¹å›¾ç‰‡è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œä»è€Œå®ç°é˜…è¯»å™¨çš„æ¸²æŸ“ã€‚ç„¶è€Œï¼Œåœ¨å®é™…å®ç°ä¸­å´é‡åˆ°äº†è®¸å¤šæ£˜æ‰‹é—®é¢˜ï¼šæ’ç‰ˆæ•ˆæœååˆ†æ€ªå¼‚ï¼Œå¯¹äºéƒ¨åˆ†ç‰¹æ®Šæ ‡ç­¾æ— æ³•å¾ˆå¥½åœ°å…¼å®¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ³¨é‡Šå›¾æ ‡å¯èƒ½ä¼šè¢«æ¸²æŸ“æˆå æ®æ•´æ•´ä¸€é¡µã€‚æœ€ç»ˆï¼Œè¿™ç§â€œè‡ªæ’ç‰ˆâ€æ–¹æ¡ˆå› ä½“éªŒä¸ä½³è€Œè¢«å¼ƒç”¨ã€‚

### æ–¹æ¡ˆäºŒï¼šWebView æ¸²æŸ“

- ç”±äº EPUB æœ¬è´¨ä¸Šæ˜¯ç”±ä¸€ç»„ XHTML æ–‡ä»¶æ„æˆï¼Œç›´æ¥ä½¿ç”¨ WebView æ¥æ¸²æŸ“æ— ç–‘æ˜¯æœ€ç®€å•ã€æœ€è¿˜åŸåŸå§‹æ ·å¼çš„æ–¹å¼ã€‚è¿™ä¸€æ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºå®ç°æˆæœ¬ä½ï¼Œèƒ½æœ€å¤§ç¨‹åº¦ä¿æŒåŸä¹¦çš„æ ·å¼å’Œæ’ç‰ˆã€‚ä½†å®ƒçš„ç¼ºé™·ä¹Ÿååˆ†æ˜æ˜¾ï¼šHTML çš„æ¸²æŸ“æ˜¯è‡ªä¸Šè€Œä¸‹çš„çº¿æ€§å¸ƒå±€ï¼Œè¦åœ¨ WebView ä¸­å®ç°åŸç”Ÿèˆ¬çš„å·¦å³ç¿»é¡µæ•ˆæœå¹¶ä¸å®¹æ˜“ã€‚æƒè¡¡å†ä¸‰ï¼Œè¿™ä¸€æ–¹æ¡ˆä¹Ÿè¢«æˆ‘æ”¾å¼ƒ

### æ–¹æ¡ˆä¸‰ï¼šåŸºäº Canvas çš„è‡ªç ”æ¸²æŸ“å¼•æ“ï¼ˆæœ€ç»ˆæ–¹æ¡ˆï¼‰

- è¿™æ˜¯ DReader æœ€ç»ˆé‡‡ç”¨çš„å®ç°æ–¹å¼ã€‚è¯¥æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè§£æ EPUB æ–‡ä»¶ä¸­çš„ XHTMLã€CSSã€å›¾ç‰‡ç­‰èµ„æºï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸º Flutter å¯æ¸²æŸ“çš„æ§ä»¶ï¼Œç›¸å½“äºåœ¨ Flutter çš„ç”»å¸ƒä¸Šâ€œé‡æ–°ç»˜åˆ¶â€é¡µé¢ã€‚ç›¸è¾ƒäº WebViewï¼Œè¿™ç§æ–¹å¼è™½ç„¶å®ç°éš¾åº¦æ›´é«˜ï¼Œä½†ä¼˜åŠ¿åœ¨äºé«˜åº¦å¯æ§ä¸å¯å®šåˆ¶åŒ–ã€‚æ¯”å¦‚æˆ‘æœ€å–œæ¬¢çš„å·¦å³ç¿»é¡µçš„åŠŸèƒ½ï¼Œåœ¨è‡ªç»˜åˆ¶çš„æ¨¡å¼ä¸‹å°±èƒ½éå¸¸è‡ªç„¶åœ°å®ç°ã€‚

## EPUB æ–‡ä»¶ç»“æ„

åœ¨å®ç°é¡¹ç›®çš„å‰æä¸‹é¦–å…ˆéœ€è¦äº†è§£çš„å°±æ˜¯è¿™ä¸ª EPUB æ–‡ä»¶åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼ŒEPUB æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼ˆåç¼€å .epubï¼‰ï¼Œå†…éƒ¨åŒ…å«ä¹¦ç±çš„æ‰€æœ‰å†…å®¹å’Œèµ„æºã€‚å…¶ç›®å½•ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤º

![è¿™æ˜¯å›¾ç‰‡](/assets/images/epubç»“æ„.png "EPUB ç»“æ„")

### å…³é”®çš„æ–‡ä»¶è¯´æ˜

- **`mimetype`**  ï¼šå¿…é¡»å­˜åœ¨ï¼Œä¸”å†…å®¹å›ºå®šä¸ºapplication/epub+zipã€‚ç”¨äºå£°æ˜æ–‡ä»¶æ˜¯ EPUB æ ¼å¼ã€‚
- **`META-INF/container.xml`**  ï¼šæŒ‡å®šä¹¦ç±çš„å…¥å£ .opf æ–‡ä»¶è·¯å¾„
- **`*.opf`**  ï¼šEPUB çš„æ ¸å¿ƒæ¸…å•æ–‡ä»¶ï¼Œå®šä¹‰äº† èµ„æºæ–‡ä»¶ã€ç« èŠ‚é¡ºåºã€å…ƒä¿¡æ¯
- **`*.xhtml`**  ï¼šä¹¦ç±çš„å®é™…æ­£æ–‡ï¼Œæ¯ä¸€ç« é€šå¸¸æ˜¯ä¸€ä¸ª XHTML æ–‡ä»¶ã€‚
- **`*.css`**  ï¼šå®šä¹‰ä¹¦ç±çš„æ’ç‰ˆå’Œæ ·å¼
- **`toc.ncx / nav.xhtml`**  ï¼šç›®å½•æ–‡ä»¶ï¼ˆEPUB 2 ç”¨ toc.ncxï¼ŒEPUB 3 ç”¨ nav.xhtmlï¼‰ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨äºç”Ÿæˆç« èŠ‚å¯¼èˆª

### EPUB æ–‡ä»¶å·¥ä½œæµç¨‹

1. **`container.xml`**  
    å‘Šè¯‰é˜…è¯»å™¨ **`.opf` æ–‡ä»¶çš„ä½ç½®**  

2. **`.opf`**  
    å®šä¹‰ **ä¹¦ç±çš„å…ƒä¿¡æ¯ã€èµ„æºæ¸…å•å’Œé˜…è¯»é¡ºåº**  

3. **`.xhtml` + `.css` + å›¾ç‰‡**  
    æ„æˆä¹¦ç±çš„ **å®é™…å±•ç¤ºå†…å®¹**  

## EPUB æ–‡ä»¶è§£æ

è¦å®ç°é˜…è¯»åŠŸèƒ½ï¼Œé¦–è¦æ­¥éª¤æ˜¯å°† EPUB æ–‡ä»¶è§£æå‡ºæ¥ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦å°† EPUB å†…éƒ¨çš„ **XHTMLã€CSS** ç­‰æ–‡ä»¶ï¼Œé€šè¿‡ Dart è¯­è¨€è½¬æ¢ä¸ºç¨‹åºå¯ä»¥ç†è§£çš„å…ƒæ•°æ®ã€‚

1. **è¯»å–å¹¶è§£å‹ EPUB æ–‡ä»¶**

    éµå¾ª EPUB çš„æ ‡å‡†å·¥ä½œæµç¨‹ï¼Œè§£æçš„è·å–åˆ°EPUBæ–‡ä»¶ä¸­çš„æ‰€æœ‰çš„æ–‡ä»¶ã€‚

    å…·ä½“çš„å®ç°æ–¹å¼æ˜¯ï¼šé¦–å…ˆå°†æ•´ä¸ª EPUB æ–‡ä»¶ï¼ˆæœ¬è´¨æ˜¯ ZIP å‹ç¼©åŒ…ï¼‰è§£å‹ï¼Œç„¶åå°†å†…éƒ¨æ‰€æœ‰æ–‡ä»¶å­˜å…¥ä¸€ä¸ª `Map` ä¸­ã€‚åœ¨è¿™ä¸ª `Map` é‡Œï¼Œ`key` æ˜¯æ–‡ä»¶åï¼ˆä¾‹å¦‚ `META-INF/container.xml`ï¼‰ï¼Œ`value` åˆ™æ˜¯å¯¹åº”æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚

    <details>
    <summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

    ```dart
    // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯EPUBæ–‡ä»¶çš„äºŒè¿›åˆ¶æµ
    Future<Map<String, List<int>>> extractEpubFromBytes(List<int> epubBytes) async {
      final archive = ZipDecoder().decodeBytes(epubBytes);
      final extractedFiles = <String, List<int>>{};

      for (final file in archive) {
        if (file.isFile) {
          extractedFiles[file.name] = file.content as List<int>;
        }
      }

      return extractedFiles;
    }
    ```

    </details>

2. **è§£æ META-INF/container.xml è·å– .opf æ–‡ä»¶**

     å¯¹äºæ‹¿åˆ°çš„ `Map` ä¸­å»æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ `META-INF/container.xml` å¹¶ä½¿ç”¨ [`XmlDocument`](https://pub.dev/packages/xml) å»è§£æè¿™ä¸ªxmlæ–‡ä»¶æ‹¿åˆ° `rootfiles` æ ‡ç­¾çš„ `full-path` å±æ€§ä»¥è·å– `.opf` æ–‡ä»¶çš„ä½ç½®

    <details>
    <summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

    ```dart
    // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯åœ¨è§£æEPUBæ–‡ä»¶æ—¶è·å–åˆ°çš„æ‰€æœ‰æ–‡ä»¶èµ„æº
    String locateOpfFile(Map<String, List<int>> files) {
        const containerPath = 'META-INF/container.xml';
        if (!files.containsKey(containerPath)) {
            throw Exception('container.xml not found!');
        }

        final containerContent = utf8.decode(files[containerPath]!);
        final document = XmlDocument.parse(containerContent);//è§£æcontainer.xml
        //æ‹¿åˆ°å¯¹åº”çš„rootfileæ ‡ç­¾ä¸‹çš„full-pathå±æ€§çš„å€¼
        final opfPath = document.findAllElements('rootfile').first.getAttribute('full-path');
        if (opfPath == null) {
            throw Exception('OPF file path not found in container.xml!');
        }

        //è¿™é‡Œåœ¨è·å–è¿™ä¸ªopfçš„çˆ¶çº§æ–‡ä»¶å¤¹
        _opfDir = opfPath.contains("/")
            ? opfPath.substring(0, opfPath.lastIndexOf("/"))
            : "";
        return opfPath;
    }
    ```

    </details>

3. **è§£æ .opf æ–‡ä»¶ä»¥è·å–èµ„æºæ–‡ä»¶åŠç« èŠ‚é¡ºåº**

   æ‹¿åˆ°å¯¹åº”çš„ `.opf` æ–‡ä»¶åå°±å¯ä»¥å¤„ç†å‡ºæ¥è¿™äº›èµ„æºæ–‡ä»¶ä»¥åŠç« èŠ‚çš„é¡ºåºäº†

    <details>
    <summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

    ```dart
            // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯åœ¨è§£æå¤„ç†å¥½çš„opfæ–‡ä»¶çš„å†…å®¹
            Map<String, dynamic> parseOpf(String opfContent) {
                final document = XmlDocument.parse(opfContent);

                // è§£æ manifest
                Map<String, String> manifest = {};
                for (final item in document.findAllElements('item')) {
                final id = item.getAttribute('id');
                final href = item.getAttribute('href');
                if (id != null && href != null) {
                    manifest[id] = href;
                }
                }

                // è§£æ spine
                final spine = document
                    .findAllElements('itemref')
                    .map((itemRef) {
                    return itemRef.getAttribute('idref');
                    })
                    .where((idref) => idref != null)
                    .toList();

                return {'manifest': manifest, 'spine': spine};
            }
    ```

    </details>

4. **ç¼–æ’å¹¶è¿”å›èµ„æºæ–‡ä»¶**

    æŒ‰ç…§ `spine` ä¸­çš„å¾ªåºæ’å¥½ç« èŠ‚ï¼Œå¹¶å°†å…¶è¿”å›å‡ºæ¥
    <details>
    <summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

    ```dart
            // è¿™é‡Œä¼ å…¥è¿›æ¥çš„æ˜¯å¤„ç†å¥½çš„manifest(èµ„æºæ–‡ä»¶)å’Œspine(æ’åº)
            List<String> readChapters(Map<String, List<int>> files,Map<String, String> manifest,List<String?> spine,) {
                final chapters = <String>[];

                for (final idref in spine) {
                String? relativePath = manifest[idref];
                if (relativePath == null) {
                    throw Exception('Warning: idref $idref not found in manifest.');
                }

                relativePath = Uri.decodeFull(relativePath);
                final chapterFile = files["$_opfDir/$relativePath"];
                if (chapterFile == null) {
                    throw Exception('Warning: Chapter file not found: $relativePath');
                }

                final content = utf8.decode(chapterFile);
                chapters.add(content);
                }

                return chapters;
            }
    ```

    </details>

## CSS æ–‡ä»¶è§£æä¸æ ·å¼é‡å†™

åœ¨æˆåŠŸè§£æå¹¶æå–å‡º EPUB æ–‡ä»¶çš„åŸºç¡€èµ„æºä¹‹åï¼Œæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯å¯¹ **CSS æ–‡ä»¶** çš„å¤„ç†ã€‚  
ä¼—æ‰€å‘¨çŸ¥ï¼ŒEPUB æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç»„ XHTML + CSS çš„ç»„åˆæ–‡ä»¶ï¼Œå› æ­¤è¦åœ¨ Flutter ä¸­å¤ç° EPUB çš„æ ·å¼æ•ˆæœï¼Œå°±å¿…é¡»è§£å†³ **å¦‚ä½•è®© Flutter æ­£ç¡®ç†è§£å¹¶æ¸²æŸ“ CSS æ ·å¼** è¿™ä¸ªé—®é¢˜ã€‚

åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ [`csslib`](https://pub.dev/packages/csslib) è¿™ä¸ªåº“æ¥è§£æ CSSã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©æˆ‘æŠŠ EPUB ä¸­çš„ CSS æ–‡ä»¶è§£æä¸º Dart ç»“æ„åŒ–æ•°æ®ï¼Œæ¥ç€æˆ‘å†å°†å…¶è§„åˆ™**é‡å†™ä¸º Flutter å¯ä½¿ç”¨çš„ `TextStyle`**ï¼Œä»¥å®ç°æ ·å¼çš„æ˜ å°„ã€‚

ä¸ºäº†æ¨¡æ‹Ÿ CSS çš„ä¼˜å…ˆçº§æœºåˆ¶ï¼Œæˆ‘è®¾è®¡äº†å››ç±»æ ·å¼é›†åˆï¼š

- `tagStyles` â€”â€” é’ˆå¯¹æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ `p`ã€`h1`  
- `classStyles` â€”â€” é’ˆå¯¹ç±»é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ `.highlight`  
- `idStyles` â€”â€” é’ˆå¯¹ ID é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ `#title`  
- `complexStyles` â€”â€” é’ˆå¯¹å¤åˆé€‰æ‹©å™¨ï¼Œä¾‹å¦‚ `p.note`  

é€šè¿‡è¿™å‡ ç±»æ ·å¼é›†åˆï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ã€Œæ ·å¼å±‚å ä¸è¦†ç›–ã€é€»è¾‘ï¼Œä»è€Œä¿è¯ä¸åŒæ¥æºçš„æ ·å¼ä¸ä¼šäº’ç›¸å†²çªã€‚

ç›®å‰é¡¹ç›®åªå®ç°äº†å¯¹ EPUB ä¸­**å¸¸ç”¨ CSS å±æ€§**çš„æ”¯æŒï¼Œä¾‹å¦‚ï¼š

- `margin` â€”â€” å¤–è¾¹è·  
- `padding` â€”â€” å†…è¾¹è·  
- `line-height` â€”â€” è¡Œé«˜  
- `font-size` â€”â€” å­—ä½“å¤§å°  

æ¢å¥è¯è¯´ç°åœ¨çš„æ ·å¼ç³»ç»Ÿè¿˜ä¸è¶³ä»¥å®Œå…¨è¿˜åŸ EPUB çš„æ’ç‰ˆæ•ˆæœï¼Œä½†å·²ç»èƒ½åº”ä»˜å¤§å¤šæ•°åŸºç¡€çš„é˜…è¯»éœ€æ±‚ã€‚  

ğŸ“Œ å…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥åœ¨æºç æ–‡ä»¶ **`CssToTextstyle.dart`** ä¸­æŸ¥çœ‹ã€‚

## è§£æDOM è·å–èŠ‚ç‚¹æ ‘

åœ¨å®Œæˆå¯¹æ‰€æœ‰ **CSS æ–‡ä»¶** çš„è§£æä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥ **XHTML æ–‡ä»¶çš„è§£æé˜¶æ®µ**ã€‚
ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€ä¸ª HTML æ–‡ä»¶é€šå¸¸ç”±ä¸€ä¸ª `<body>` èŠ‚ç‚¹åŒ…è£¹ä½å…¶å†…éƒ¨çš„æ‰€æœ‰ DOMï¼Œè€Œ DOM ä¹‹é—´åˆå¯èƒ½å­˜åœ¨åµŒå¥—å…³ç³»ã€‚è¿™ç§åµŒå¥—å¼çš„ DOM ç»“æ„ï¼Œæœ€ç»ˆæ„æˆäº†æˆ‘ä»¬æ—¥å¸¸çœ‹åˆ°çš„ç½‘é¡µå¸ƒå±€ã€‚

å› æ­¤ï¼Œåœ¨è§£æ XHTML æ–‡ä»¶æ—¶ï¼Œæˆ‘åŒæ ·ä¿ç•™äº†è¿™ç§ **åµŒå¥— DOM çš„å±‚çº§ç»“æ„**ï¼Œä»¥ä¾¿åç»­åœ¨æ¸²æŸ“é˜¶æ®µèƒ½å¤Ÿæ­£ç¡®åœ°è¿˜åŸå‡º DOM ä¹‹é—´çš„æ’ç‰ˆå…³ç³»ã€‚

åœ¨è§£æ XHTML æ–‡ä»¶æ—¶ï¼Œæˆ‘ä½¿ç”¨äº† [`html`](https://pub.dev/packages/html) åº“æ¥å®Œæˆå¯¹ DOM èŠ‚ç‚¹çš„è§£æã€‚ `html` åº“å¯ä»¥å°† XHTML å†…å®¹è½¬æ¢ä¸º Dart çš„ DOM å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­çš„é€’å½’éå†å’ŒèŠ‚ç‚¹æ ‘æ„å»ºã€‚

å…¶ä¸­è¿™é‡Œé¢çš„è¿™äº› `Node` ç±»ï¼Œéƒ½æ˜¯å¯¹åº”çš„ DOM å®ç°èŠ‚ç‚¹ç±»ï¼Œå…·ä½“ç»†èŠ‚ä¼šåœ¨ **ä¸‹ä¸€ä¸ªç« èŠ‚** ä¸­å±•å¼€è¯´æ˜ã€‚

ä»¥ä¸‹æ˜¯æˆ‘å¯¹ XHTML DOM èŠ‚ç‚¹çš„å¤„ç†é€»è¾‘ï¼š

```dart
// å‚æ•°è¯´æ˜ï¼š
// nodes    â€”â€” å½“å‰èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨
// baseStyle â€”â€” å½“å‰èŠ‚ç‚¹å·²æœ‰çš„æ ·å¼
// useCss   â€”â€” å½“å‰ä½¿ç”¨åˆ°çš„ CSS æ–‡ä»¶é›†åˆ
  Future<List<ReaderNode>> domParse(List<dom.Node> nodes, ModelStyle baseStyle, List<String> useCss) async {
    List<ReaderNode> list = [];
    for (var node in nodes) {
      ReaderNode readerNode;
      // æ‹·è´çˆ¶çº§æ ·å¼ï¼Œä½œä¸ºå½“å‰èŠ‚ç‚¹çš„åŸºç¡€æ ·å¼
      ModelStyle style = baseStyle.clone();

      //åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºæ–‡æœ¬èŠ‚ç‚¹å°±å¯ä»¥ç›´æ¥æ·»åŠ åˆ°è¿™ä¸ªList<ReaderNode> listä¸­
      //æ–‡æœ¬èŠ‚ç‚¹å°±æ˜¯ä¸ä¼šå­˜åœ¨å­èŠ‚ç‚¹
      if (node is dom.Text) {
        String text = node.text;
        text = text.replaceAll('\n', '').trim(); //å»é™¤æ‰æ–‡æœ¬ä¸­çš„'\n'æ¢è¡Œç¬¦
        if (text.isNotEmpty) {
          list.add(TextNode(TextSpan(text: text, style: style.textStyle), style, nodeIndex));
        }
      }
      // å…ƒç´ èŠ‚ç‚¹ï¼šå¯èƒ½åŒ…å«å­èŠ‚ç‚¹ï¼Œéœ€è¦è¿›ä¸€æ­¥è§£æ
       else if (node is dom.Element) {
        //åˆ¤æ–­ä½¿ç”¨äº†é‚£äº›cssæ–‡ä»¶ï¼Œå°†å¯¹åº”çš„æ ·å¼åŒ¹é…åˆ°å½“å‰çš„ModelStyleä¸­
        for (String css in useCss) {
          style = getStyle(css, style, node);
        }

        //è¡Œå†…æ ·å¼åº”ä¸ºä¸åœ¨cssæ–‡ä»¶ä¸­æ‰€ä»¥éœ€è¦å•ç‹¬çš„å¤„ç†
        String? nodeStyle = node.attributes["style"];
        if (nodeStyle != null) {
          style = style.merge(cssToTextstyle.parseInlineStyle(nodeStyle));
        }

        //HTMLä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºinline(è¡Œå†…)å’Œblock(å—çº§)
        if (blockList.contains(node.localName)) {
          readerNode = BlockNode(node.localName!, style, nodeIndex);
        } else {
          if (["image", "img"].contains(node.localName)) {
            String? path = getImageBytes(node);
            if (path == null) continue;
            List<int>? list = epubParsing.getImage(path);
            if (list == null || list.isEmpty) continue;
            readerNode = ImageNode(node.localName!, style, nodeIndex, list, path);
            await (readerNode as ImageNode).decode();
          } else if (node.localName == "i") {
            readerNode = INode("i", style, nodeIndex);
          } else if (node.localName == "ruby") {
            readerNode = RubyNode("ruby", style, nodeIndex);
          } else if (node.localName == "rt") {
            readerNode = RtNode("rt", style, nodeIndex);
          } else if (node.localName == "br") {
            readerNode = BrNode("br", style, nodeIndex);
          } else if (node.localName == "del") {
            readerNode = DelNode("del", style, nodeIndex);
          } else if (node.localName == "b") {
            readerNode = BNode("b", style, nodeIndex);
          } else {
            readerNode = InlineNode(node.localName!, style, nodeIndex);
          }
        }

        //åœ¨readerNodeæœ‰åšç‰¹æ®Šå¤„ç†å¯èƒ½è¦ç»§æ‰¿åˆ°å­èŠ‚ç‚¹ä¸­
        style = readerNode.styleModel;
        //é€’å½’è§£æå­èŠ‚ç‚¹
        readerNode.children = await domParse(node.nodes, style, useCss);
        // åŠ å…¥ç»“æœåˆ—è¡¨
        list.add(readerNode);
      }
      nodeIndex++;
    }
    return list;
  }
```

å½“ `domParse` æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œä¼šå¾—åˆ°ä¸€ä¸ª **æ ‘å½¢ç»“æ„çš„èŠ‚ç‚¹æ ‘**ï¼Œè¯¥ç»“æ„å®Œæ•´ä¿ç•™äº† XHTML ä¸­çš„å±‚çº§ä¸æ’ç‰ˆå…³ç³»ã€‚  
ä¸ºäº†ä¾¿äºåç»­çš„ **åˆ†é¡µæ¸²æŸ“**ï¼Œéœ€è¦å°†è¿™ä¸ªèŠ‚ç‚¹æ ‘ä¿å­˜èµ·æ¥ï¼Œä½œä¸ºåç»­æ¸²æŸ“çš„åŸºç¡€æ•°æ®ã€‚

```dart
...çœç•¥éƒ¨åˆ†ä»£ç 
List<ReaderNode> nodeList = await domParse(document.body?.nodes ?? [], ModelStyle(), useCss);
  if (nodeList.length > 1) {
    BodyNode bodyNode = BodyNode();
    bodyNode.children = nodeList;
    nodeListList.add([bodyNode]);
  } else {
    nodeListList.add(nodeList);
  }
...çœç•¥éƒ¨åˆ†ä»£ç 
```

## ReaderNode è®¾è®¡

åœ¨ EPUB é˜…è¯»å™¨çš„å®ç°ä¸­ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ **å°†è§£æåçš„ XHTML DOM èŠ‚ç‚¹æ˜ å°„ä¸º Flutter å¯æ¸²æŸ“çš„èŠ‚ç‚¹æ ‘**ã€‚  
ä¸ºæ­¤ï¼Œæˆ‘è®¾è®¡äº†ä¸€å¥— **`ReaderNode` æŠ½è±¡ç±»** åŠå…¶å­ç±»ï¼Œç”¨æ¥æ‰¿è½½ DOM çš„ **è¯­ä¹‰ã€æ ·å¼ã€æ’ç‰ˆå’Œç»˜åˆ¶é€»è¾‘**ã€‚

### æ ¸å¿ƒæ€æƒ³

- æ¯ä¸€ä¸ª `ReaderNode` å¯¹åº”ç€ä¸€ä¸ª DOM èŠ‚ç‚¹ï¼Œè´Ÿè´£å­˜å‚¨è¯¥èŠ‚ç‚¹çš„ **æ ·å¼ä¿¡æ¯**ã€**å¸ƒå±€ä½ç½®**ã€**å¤§å°** ä»¥åŠ **å­èŠ‚ç‚¹æ ‘**ã€‚
- è¿™æ ·ï¼Œè§£æåçš„ XHTML èŠ‚ç‚¹æ ‘å°±èƒ½ç›´æ¥å‚ä¸åˆ°åˆ†é¡µæ’ç‰ˆä¸æ¸²æŸ“ä¸­ã€‚

### å…³é”®æ–¹æ³•

- **`layout`**ï¼šè´Ÿè´£è®¡ç®—èŠ‚ç‚¹åœ¨é¡µé¢ä¸­çš„å¸ƒå±€ï¼ˆä½ç½®ã€é«˜åº¦ã€å®½åº¦ï¼‰ï¼Œä»¥åŠæ˜¯å¦éœ€è¦åˆ†é¡µæˆ–æ¢è¡Œã€‚
- **`paint`**ï¼šè´Ÿè´£å°†èŠ‚ç‚¹ç»˜åˆ¶åˆ° `Canvas` ä¸Šã€‚
- **`deepUpdateOffset`**ï¼šç”¨äºåŒä¸€è¡Œå†…çš„èŠ‚ç‚¹å¯¹é½ï¼ˆå¦‚å‚ç›´å±…ä¸­ï¼‰ã€‚

### ReaderNode æŠ½è±¡ç±»

```dart
abstract class ReaderNode {
  static int page = 0;
  static List<List<ReaderNode>> list = [];
  List<ReaderNode> children = []; //å­èŠ‚ç‚¹åˆ—è¡¨
  late ModelStyle styleModel;//æ ·å¼
  bool isTurning;//åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆ†åˆ†é¡µ
  bool isEnter;//åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦åˆ†è¡Œ
  bool isBranch = true;//èŠ‚ç‚¹æ˜¯å¦å…è®¸åˆ†è¡Œ
  double? remainingHeight;//å½“å‰é¡µé¢å‰©ä½™é«˜åº¦
  Offset currentOffset = const Offset(0, 0);//è¯¥èŠ‚ç‚¹ç»˜åˆ¶çš„ä½ç½®
  Offset? nextOffset;//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»˜åˆ¶çš„ä½ç½®
  double currentHeight = 0;//å½“å‰èŠ‚ç‚¹çš„é«˜åº¦
  double currentWidth = 0;//å½“å‰èŠ‚ç‚¹çš„å®½åº¦
  int uniqueId;//èŠ‚ç‚¹çš„å”¯ä¸€ID
  bool isCurrent = false;
  List<int> hasIndexList = [];//è¯¥èŠ‚ç‚¹åŒ…æ‹¬å…¶å­èŠ‚ç‚¹çš„uniqueId

  ReaderNode(this.styleModel, this.uniqueId,{this.isTurning = false, this.isEnter = false});

  //å¸ƒå±€å‰çš„æ“ä½œ
  void layoutBefore() {
    hasIndexList = [uniqueId];
    isTurning = false;
    isEnter = false;
  }

  //å¸ƒå±€æ–¹æ³•äº¤ç”±å­ç±»å®ç°
  List<ReaderNode> layout(double availableWidth, Offset offset,{isFull = true});

  //ç»˜åˆ¶æ–¹æ³•äº¤ç”±å­ç±»å®ç°
  void paint(Canvas canvas, Offset offset);

  //è¯¥æ–¹æ³•ä¸»è¦ç”¨äºåŒä¸€è¡Œå†…çš„æ‰€æœ‰èŠ‚ç‚¹å‚ç›´å±…ä¸­
  void deepUpdateOffset(double dxDifference, double dyDifference) {
    for (var element in children) {
      element.deepUpdateOffset(dxDifference, dyDifference);
    }
    currentOffset = Offset(currentOffset.dx + dxDifference, dyDifference + currentOffset.dy);
    if (nextOffset != null) {
      nextOffset = Offset(nextOffset!.dx + dxDifference, dyDifference + nextOffset!.dy);
    }
  }

  ReaderNode clone() {
    return this;
  }
}
```

é€šè¿‡ç»§æ‰¿è¿™ä¸ªæ–¹æ³•å»å®ç°å¸ƒå±€ä¸ç»˜åˆ¶çš„åŠŸèƒ½ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªæœ€é‡è¦çš„å®ç°ç±»ï¼Œ

### TextNode ç±»

`TextNode` ç±»ç»§æ‰¿è‡ª `ReaderNode` æŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨äº **ç»˜åˆ¶æ–‡æœ¬**ã€‚  
å®ƒçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å€ŸåŠ© **Flutter çš„ `TextPainter`** æ¥å®Œæˆæ–‡æœ¬çš„ **å¸ƒå±€è®¡ç®—** ä¸ **æ¸²æŸ“ç»˜åˆ¶**ã€‚

åœ¨ `layout` æ–¹æ³•ä¸­ï¼Œ`TextNode` è´Ÿè´£ä»¥ä¸‹å·¥ä½œï¼š

- å½“ `availableWidth`ï¼ˆå¯ç”¨å®½åº¦ï¼‰ä¸è¶³æ—¶ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œ **åˆ‡å‰²æ¢è¡Œ**ã€‚
- å½“æ–‡æœ¬é«˜åº¦è¶…è¿‡ `remainingHeight`ï¼ˆé¡µé¢å‰©ä½™é«˜åº¦ï¼‰æ—¶ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œ **åˆ†é¡µæˆªæ–­**ã€‚
- è®¡ç®—èŠ‚ç‚¹çš„ **ä½ç½® (Offset)**ã€**é«˜åº¦**ã€**å®½åº¦**ï¼Œå¹¶ç”Ÿæˆä¸‹ä¸€èŠ‚ç‚¹çš„èµ·å§‹åæ ‡ã€‚

<details>
<summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

```dart
class TextNode extends ReaderNode {
  TextSpan textSpan;//åœ¨è§£æDomæ—¶ä¼ å…¥çš„æ–‡æœ¬å†…å®¹
  TextPainter? textPainter;
  List<ReaderNode> listNode = [];//è¿”å›å‡ºå»äº¤ç”±ElementNodeå¤„ç†çš„é›†åˆ

  TextNode(
      this.textSpan,
      super.styleModel,
      super.uniqueId
      );

  //å½“è¿™é‡Œçš„textPainterä¸ä¸ºnullçš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ç»˜åˆ¶è¿™ä¸ªæ–‡æœ¬åˆ°ç”»å¸ƒä¸Šäº†
  @override
  void paint(Canvas canvas, Offset offset) {
    if (textPainter != null) {
      textPainter!.paint(canvas, offset);
    }
  }

  // å¸ƒå±€æ–¹æ³•ï¼šè®¡ç®—æ–‡æœ¬çš„å®½é«˜ã€åˆ†é¡µé€»è¾‘ã€æ¢è¡Œé€»è¾‘
  @override
  List<ReaderNode> layout(double availableWidth, Offset offset, {isFull = true}) {
    layoutBefore();

    // åˆå§‹åŒ– TextPainter
    textPainter = TextPainter(text: textSpan, textDirection: TextDirection.ltr);
    textPainter!.layout(maxWidth: availableWidth);

    currentOffset = offset;
    double lastWidth = 0;//æœ€åä¸€è¡Œçš„å®½åº¦ï¼Œä»¥æ–¹ä¾¿è®¡ç®—

    //åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å¤´
    if (!isFull) {
      //å¦‚æœä¸æ˜¯å¼€å¤´çš„è¯(æ„åŠæ”¹è¡Œä¸­æœ‰å…¶ä»–çš„èŠ‚ç‚¹å­˜åœ¨)
      // è·å–åœ¨æœ€å¤§å®½åº¦å¤„çš„æ–‡æœ¬ä½ç½®
      TextPosition pos = textPainter!.getPositionForOffset(Offset(availableWidth, 0));
      final splitIndex = pos.offset;
      if (splitIndex != textSpan.text!.length) {
        //è¯¥è¡Œæ”¾ä¸ä¸‹æ‰€æœ‰çš„æ–‡æœ¬ï¼Œå°†åˆ†è¡Œæ ‡è®°ä¸ºtrueç­‰å¾…ElementNodeå¤„ç†
        isEnter = true;
        if (splitIndex == 0 || (splitIndex < textSpan.text!.length && !isBranch)) {
          segmentation(0,0);
          return listNode;
        }

        segmentation(splitIndex, availableWidth);
      }
    }

    //é€šè¿‡computeLineMetricsæ–¹æ³•æ¥è·å–åˆ°æ–‡æœ¬å¸ƒå±€çš„è¯¦ç»†è¡Œåº¦é‡ä¿¡æ¯
    List<LineMetrics> list = textPainter!.computeLineMetrics();
    if (list.isEmpty) return [];
    lastWidth = list.last.width;
    //å½“æ–‡æœ¬çš„é«˜åº¦å¤§äºé¡µé¢å‰©ä½™é«˜åº¦å°±è¦å¼€å§‹å¤„ç†åˆ†é¡µçš„é—®é¢˜
    if (textPainter!.height > remainingHeight!) {
      int endOffset = 0;
      double totalHeight = 0;
      for (LineMetrics lineMetrics in list) {
        totalHeight += lineMetrics.height;//å°†æ¯ä¸€è¡Œæ–‡æœ¬çš„é«˜åº¦ç›¸åŠ 
        if (totalHeight > remainingHeight!) break;


        //è¿™é‡Œçš„è®¡ç®—æ—¶å› ä¸ºè€ƒè™‘åˆ°æ–‡æœ¬ä¸å¯èƒ½æ¯ä¸€è¡Œéƒ½å¯ä»¥å®Œå®Œå…¨å…¨çš„å æ»¡ï¼Œæœ€åä¸€è¡Œæœ‰å¯èƒ½æœ‰å‰©ä½™çš„å®½åº¦å¯ä»¥ç»™åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœç›´æ¥æ‹¿å–textPainterçš„å®½åº¦çš„è¯ï¼Œæ˜¯ç›´æ¥æ‹¿åˆ°æ•´ä¸ªæ–‡æœ¬çš„å®½åº¦ï¼Œè€Œä¸æ˜¯æœ€åä¸€è¡Œçš„å®½åº¦ï¼Œæ‰€ä»¥è¿™é‡Œè¦å°†è¿™ä¸ªæœ€åä¸€è¡Œçš„å®½åº¦è®¡ç®—å‡ºæ¥
        final lineEndOffset = textPainter!.getPositionForOffset(Offset(lineMetrics.left + lineMetrics.width, lineMetrics.baseline)).offset;
        lastWidth = lineMetrics.width;
        endOffset = lineEndOffset;
      }

      //å°†åˆ†é¡µæ ‡è®°æ”¹ä¸ºtrue
      isTurning = true;
      segmentation(endOffset, availableWidth);
    }

    
    double dx = list.last.width + currentOffset.dx;//è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ¨Xè½´ä¸Šçš„ä½ç½®
    double dy = currentOffset.dy + textPainter!.height - list.last.height;//è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ¨Yè½´ä¸Šçš„ä½ç½®
    currentHeight = textPainter!.height;
    currentWidth = textPainter!.width;
    nextOffset = Offset(dx, dy);
    return listNode;
  }

  //
  void segmentation(int index, double maxWidth) {
    String remainingText = textSpan.text!.substring(index);
    TextSpan newTextSpan = TextSpan(text: remainingText, style: textSpan.style);
    TextNode newTextNode = TextNode(newTextSpan, styleModel,uniqueId);
    listNode.insert(0, newTextNode);
    String currentText = textSpan.text!.substring(0, index);
    textSpan = TextSpan(text: currentText, style: textSpan.style);
    textPainter = TextPainter(text: textSpan, textDirection: TextDirection.ltr);
    textPainter!.layout(maxWidth: maxWidth);
  }
}

```

</details>

### ElementNode ç±»

`ElementNode` ç»§æ‰¿è‡ª `ReaderNode`ï¼Œæ˜¯æ¸²æŸ“å™¨ä¸­ **è´Ÿè´£æ•´ä½“å¸ƒå±€ä¸æ’ç‰ˆçš„æ ¸å¿ƒèŠ‚ç‚¹**ã€‚  
ç”±äº DOM è§£æåçš„å†…å®¹ä¼šè¢«ç»„ç»‡ä¸º `ReaderNode` æ ‘ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹çš„æ’ç‰ˆä¸åˆ†é¡µé€»è¾‘ï¼Œéƒ½ä¼šåœ¨ `ElementNode` çš„ `layout` æ–¹æ³•ä¸­è¢«ç»Ÿä¸€è°ƒåº¦ä¸å¤„ç†ã€‚  

å®ƒçš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š  

- **å­èŠ‚ç‚¹æ’ç‰ˆç®¡ç†**ï¼šé€ä¸ªå¯¹å­èŠ‚ç‚¹è°ƒç”¨ `layout`ï¼Œå¹¶æ ¹æ®è¡Œå†…/å—çº§ç‰¹æ€§è¿›è¡Œå¸ƒå±€ã€‚  
- **åˆ†é¡µé€»è¾‘æ§åˆ¶**ï¼šå½“å½“å‰é¡µå‰©ä½™é«˜åº¦ä¸è¶³æ—¶ï¼Œè§¦å‘åˆ†é¡µå¹¶å…‹éš†è‡ªèº«ï¼Œä»¥ä¿æŒæ ‘ç»“æ„çš„å®Œæ•´æ€§ã€‚  
- **å—çº§ä¸è¡Œå†…å…ƒç´ åŒºåˆ†**ï¼š  
  - å—çº§å…ƒç´ ç‹¬å ä¸€è¡Œï¼Œä¼šå¤„ç†å¤–è¾¹è·ä¸å†…è¾¹è·ã€‚  
  - è¡Œå†…å…ƒç´ åˆ™ä¼šå‚ä¸åŒä¸€è¡Œçš„æ’ç‰ˆï¼Œå¹¶è‡ªåŠ¨å¯¹é½è°ƒæ•´ã€‚  
- **è¡Œå†…é«˜åº¦å¯¹é½**ï¼šè‹¥åŒä¸€è¡Œå†…çš„èŠ‚ç‚¹é«˜åº¦ä¸ä¸€è‡´ï¼Œä¼šé€šè¿‡ `rearrangement` æ–¹æ³•é‡æ–°è°ƒæ•´åç§»ï¼Œä¿è¯è§†è§‰å¯¹é½ã€‚  
- **é€’å½’æ¸²æŸ“**ï¼šåœ¨ `paint` é˜¶æ®µä¼šé€’å½’è°ƒç”¨å­èŠ‚ç‚¹çš„ `paint`ï¼Œæœ€ç»ˆå®Œæˆæ•´é¡µå†…å®¹çš„ç»˜åˆ¶ã€‚  

å› æ­¤ï¼Œ`ElementNode` å¯ä»¥ç†è§£ä¸º **ReaderNode æ ‘çš„â€œç‰ˆé¢è°ƒåº¦å™¨â€**ï¼Œå®ƒä¸ä»…è´Ÿè´£ç®¡ç†å­èŠ‚ç‚¹çš„ä½ç½®ä¸åˆ†é¡µï¼Œè¿˜ä¿è¯äº†æ•´æ£µæ¸²æŸ“æ ‘åœ¨è§†è§‰å’Œé€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç±»ç»§æ‰¿è‡ª `ElementNode`ï¼Œå®ƒä»¬å¯èƒ½ä¼šé‡å†™ `layout` æ–¹æ³•ä»¥å®ç°æ›´ç‰¹æ®Šçš„å¸ƒå±€é€»è¾‘ã€‚  
ä½†åœ¨è¿™é‡Œä¸å±•å¼€è¯´æ˜ï¼Œ**`ElementNode` æ˜¯æ¸²æŸ“å™¨ä¸­æ‰®æ¼”å¸ƒå±€é‡ä»»çš„æ ¸å¿ƒç±»**ï¼Œæ˜¯æ•´ä¸ª ReaderNode æ ‘æœ€ç»ˆæ’ç‰ˆçš„è°ƒåº¦å™¨ã€‚  

<details>
<summary>ğŸ“„æŸ¥çœ‹ä»£ç </summary>

```dart
class ElementNode extends ReaderNode {
  String tag; //æ ‡ç­¾

  ElementNode(
    this.tag,
    super.styleModel,
    super.uniqueId,
  );

  double defaultDx = 0;
  double defaultDy = 0;
  bool isOver = true; //åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦å®Œæˆäº†
  List<ReaderNode> truncatedNode = [];//æ‹¿å–è£æ–­åˆ†é¡µèŠ‚ç‚¹
  List<ReaderNode> nextPageNode = [];//æœ¬é¡µæ”¾ä¸ä¸‹è¦åˆ°ä¸‹é¡µæ¸²æŸ“çš„èŠ‚ç‚¹é›†åˆ
  double currentLineHeight = 0;//å½“å‰è¡Œçš„é«˜åº¦
  double currentLineWidth = 0;//å½“å‰è¡Œçš„å®½åº¦
  int truncatedIndex = -1;
  List<int> currentLineIndex = []; //å½“å‰è¡Œå«æœ‰çš„æ‰€æœ‰å­èŠ‚ç‚¹ä¸‹æ ‡
  bool highlyInconsistent = false;//åˆ¤æ–­æ˜¯å¦å‚ç›´å±…ä¸­

  @override
  List<ReaderNode> layout(double availableWidth, Offset offset, {isFull}) {
    layoutBefore();
    currentOffset = offset;
    remainingHeight ??= NodeStatus.pageHeight;//å½“remainingHeightä¸ºç©ºåˆ™ç›´æ¥é‚£å½“å‰çš„é¡µé¢çš„é«˜åº¦ä½œä¸ºå‰©ä½™é«˜åº¦
    defaultDx = offset.dx;
    double top = 0;

    //åˆ¤æ–­å¦‚æœä¸ºå—çº§å…ƒç´ åˆ™è¦åŠ ä¸Šè¿™ä¸ªå¤–è¾¹è·å’Œå†…è¾¹è·çš„å®ç°
    if (this is BlockNode) {
      void applyEdgeInsets(EdgeInsets? insets) {
        if (insets == null) return;

        availableWidth -= insets.left + insets.right;
        defaultDx += insets.left;

        if (insets.top != 0 && isOver) {
          top += insets.top;
        }
      }

      applyEdgeInsets(styleModel.margin);
      applyEdgeInsets(styleModel.padding);
    }

    //å°†é«˜åº¦å’Œé»˜è®¤ä½ç½®çš„yè½´åŠ ä¸Šå¯¹åº”çš„å¤–è¾¹è·å’Œå†…è¾¹è·ä¸Šè¾¹çš„å€¼
    defaultDy = offset.dy + top;
    currentHeight += top;

    //åˆ¤æ–­æœç„¶å½“å‰çš„ä½ç½®ä»¥åŠé«˜å‡ºé¡µé¢çš„é«˜åº¦ä»¥åŠè¿™ä¸ªèŠ‚ç‚¹è¿˜å­˜åœ¨å­èŠ‚ç‚¹å°±ç›´æ¥åˆ†é¡µ
    if (defaultDy >= NodeStatus.pageHeight && children.isNotEmpty) {
      isTurning = true;
    }

    if (isTurning) {
      //éœ€è¦åˆ†é¡µçš„æ—¶å€™ç›´æ¥å…‹éš†ä¸€ä¸ªè‡ªå·±
      final blockNode = clone();
      blockNode.currentOffset = Offset(defaultDx, 0);
      blockNode.children = children;
      children = [];
      return [blockNode];
    }
    Offset? nextChildOffset = Offset(defaultDx, defaultDy);
    double unchanged = availableWidth;

    if (children.isNotEmpty) {
      int childIndex = 0;

      //è¿™é‡Œä½¿ç”¨whileè€Œä¸æ˜¯ä½¿ç”¨forå»å¾ªç¯è¿™ä¸ªchildrençš„åŸå› æ˜¯éœ€è¦é¿å…åœ¨å¾ªç¯ä¸­ä¿®æ”¹äº†childrené•¿åº¦çš„å‰¯ä½œç”¨
      while (childIndex != children.length) {
        ReaderNode child = children[childIndex];
        //è®¡ç®—å­èŠ‚ç‚¹å‰©ä½™å¯ä½¿ç”¨çš„é«˜åº¦
        //ä½¿ç”¨é¡µé¢é«˜åº¦ - å½“å‰èŠ‚ç‚¹çš„Yè½´ä¸Šçš„ä½ç½® - å½“å‰èŠ‚ç‚¹ï¼ˆåŒ…å«æ‰€æœ‰å·²å¤„ç†çš„å­èŠ‚ç‚¹ï¼‰çš„é«˜åº¦
        child.remainingHeight = NodeStatus.pageHeight - currentOffset.dy - currentHeight;
        bool isFull = unchanged == availableWidth;//åˆ¤æ–­æ˜¯å¦è¡Œé¦–ï¼ˆæ„ä¸ºåˆ¤æ–­æ˜¯å¦ä¸ºè¯¥è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
        child.isBranch = isBranch; //æ˜¯å¦å…è®¸æ–‡æœ¬åˆ†è¡Œï¼ˆè¿™é‡Œæ˜¯ä¸ºäº†ç»™ä¾‹å¦‚Rubyæ ‡ç­¾è¿™æ ·çš„èŠ‚ç‚¹ä½¿ç”¨çš„ï¼‰

        //åˆ¤æ–­æ˜¯å—çº§èŠ‚ç‚¹è¿˜æ˜¯å…¶ä»–èŠ‚ç‚¹
        if (child is BlockNode) {
          currentHeight += currentLineHeight; // åŠ ä¸Šä¸Šä¸€è¡Œçš„æœ€ç»ˆé«˜åº¦
          currentLineHeight = 0;
          // å—çº§èŠ‚ç‚¹Yè½´ä»å½“å‰èŠ‚ç‚¹ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯è¿™ä¸ªå—çº§èŠ‚ç‚¹çš„çˆ¶çº§ï¼‰é«˜åº¦å¼€å§‹
          nextChildOffset = Offset(defaultDx, offset.dy + currentHeight);
          //å› ä¸ºæ˜¯å—çº§èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é‚£unchangedï¼ˆæœ€å¤§å®½åº¦ï¼‰æ¥ä½¿ç”¨
          truncatedNode = child.layout(unchanged, nextChildOffset);
          currentHeight += child.currentHeight;
          // å› ä¸ºå—çº§èŠ‚ç‚¹æ˜¯ç‹¬å çš„å­˜åœ¨ï¼Œä¸å¯èƒ½æœ‰å…¶ä»–èŠ‚ç‚¹ä¼šå’Œå—çº§èŠ‚ç‚¹åœ¨åŒä¸€è¡Œçš„
          // æ‰€ä»¥å¯ä»¥ç›´æ¥æ¸…ç©ºcurrentLineHeightå»ç»™ä¸‹ä¸€è¡Œåšåˆ¤æ–­
          currentLineHeight = 0; 
        } else {
          truncatedNode = child.layout(availableWidth, nextChildOffset!, isFull: isFull);
          //å åŠ è®¡ç®—è¿™ä¸ªè¡Œå†…çš„æ‰€æœ‰å…ƒç´ çš„å®½åº¦
          currentLineWidth += child.currentWidth;
          //åˆ¤æ–­å½“å‰è¡Œçš„é«˜åº¦å’Œè¿™ä¸ªè¡Œå†…å…ƒç´ çš„é«˜åº¦ï¼Œå¦‚æœé«˜åº¦ä¸åŒæ ‡è®°highlyInconsistentä¸ºtrue
          if (child.currentHeight != currentLineHeight &&
              currentLineHeight > 0 &&
              !highlyInconsistent) {
            highlyInconsistent = true;
          }
          //è¿™é‡Œå†è´§æ¯”åŒä¸€è¡Œå†…çš„æ‰€æœ‰Nodeçš„é«˜åº¦ï¼Œæ‹¿å–æœ€é«˜çš„èŠ‚ç‚¹é«˜åº¦ä¸ºå½“å‰è¡Œçš„é«˜åº¦
          currentLineHeight =max(currentLineHeight, child.currentHeight); 
          //è®¡ç®—å½“å‰è¡Œçš„å‰©ä½™å¯ç”¨å®½åº¦
          availableWidth = availableWidth - child.currentWidth;
          currentLineIndex.add(childIndex);
        }

        currentWidth = max(currentWidth, currentLineWidth);

        //è¿™é‡Œå°†è¯¥å­èŠ‚ç‚¹å«æœ‰æ‰€æœ‰çš„ä¸‹æ ‡æ·»åŠ åˆ°å½“å‰èŠ‚ç‚¹çš„hasIndexListä¸‹ï¼Œåç»­è¦åšå·²çœ‹è¿›åº¦çš„è·³è½¬
        //æ ¹æ®è¿™ä¸ªä¸‹æ ‡çš„å€¼æ¥è·³è½¬ç›¸åº”çš„é¡µç 
        hasIndexList.addAll(child.hasIndexList);
        if (child.isEnter || child.isTurning || availableWidth <= 0) {
          currentHeight += currentLineHeight;
          rearrangement();
          currentLineWidth = 0;
          currentLineHeight = 0;
          currentLineIndex = [];
          if (child.isTurning) {
            //å¦‚æœå­èŠ‚ç‚¹çš„isTurningæ ‡è®°ä¸ºtrueå°±ä»£è¡¨ä»è¿™ä¸ªå­èŠ‚ç‚¹å¼€å§‹éœ€è¦åˆ†é¡µäº†
            //å½“å‰èŠ‚ç‚¹ä¹Ÿæ ‡è®°ä¸ºéœ€è¦åˆ†é¡µï¼Œå‘ä¸Šä¼ é€’
            isTurning = true;
            turning(childIndex);
            break;
          } else if (child.isEnter || availableWidth <= 0) {
            //å½“å­èŠ‚ç‚¹éœ€è¦åˆ†è¡Œæˆ–è€…æ˜¯å½“å‰å‰©ä½™å®½åº¦å·²ç»ä¸å¤Ÿç”¨äº†
            availableWidth = unchanged;
            nextChildOffset = Offset(defaultDx, defaultDy + currentHeight);
            childIndex++;
            //å¾€å½“å‰èŠ‚ç‚¹çš„å­—èŠ‚æ’å…¥ä¸€ä¸ªæ–°çš„åˆ†è¡Œåçš„èŠ‚ç‚¹
            children.insertAll(childIndex, truncatedNode);
            continue;
          }
        }
        nextChildOffset = child.nextOffset ?? Offset(defaultDx, defaultDy);
        childIndex++;
        isOver = true;
      }
      rearrangement();
    }

    //å¤„ç†æœ€åä¸€è¡Œçš„é«˜åº¦æ²¡æœ‰æ·»åŠ åˆ°å½“å‰çš„èŠ‚ç‚¹çš„é«˜åº¦ä¸Š
    if (currentLineHeight > 0) {
      currentHeight += currentLineHeight;
      currentLineHeight = 0;
    }

    //åˆ¤æ–­å¦‚æœä¸ºå—çº§å…ƒç´ åˆ™è¦åŠ ä¸Šè¿™ä¸ªå¤–è¾¹è·å’Œå†…è¾¹è·çš„å®ç°
    if (this is BlockNode) {
      //åˆ¤æ–­isOverçš„åŸå› æ˜¯å¯èƒ½è¿™ä¸ªå—çº§èŠ‚ç‚¹åœ¨è¿™ä¸ªé¡µé¢è£…ä¸ä¸‹äº†ï¼Œç„¶åéœ€è¦å»åˆ°ä¸‹ä¸€é¡µ
      //é‚£ä¹ˆå½“å‰é¡µé¢çš„è¿™ä¸ªå—çº§èŠ‚ç‚¹å°±ä¸éœ€è¦ä¸‹è¾¹çš„è¾¹è·äº†
      if (isOver) {
        currentHeight += (styleModel.padding?.bottom ?? 0);
        currentHeight += (styleModel.margin?.bottom ?? 0);
      }
    }
    nextOffset = nextChildOffset;
    //truncatedIndexä¸ä¸º-1çš„æ—¶å€™è¯´æ˜å½“å‰é¡µé¢æ˜¯éœ€è¦åˆ†é¡µï¼Œæ‰€ä»¥ç›´æ¥è£æ–­è¿™ä¸ªchildren
    //è¿™æ ·åœ¨è°ƒç”¨printæ–¹æ³•ç»˜åˆ¶çš„æ—¶å€™å°±ä¸ä¼šå‡ºç°ç»˜åˆ¶å¤šä½™çš„èŠ‚ç‚¹äº†
    if (children.isNotEmpty && truncatedIndex != -1) {
      children = children.sublist(0, truncatedIndex + 1);
    }
    return nextPageNode;
  }

  void turning(childIndex) {
    isOver = false;
    //æ‹·è´ä¸€ä¸ªå½“å‰èŠ‚ç‚¹ï¼Œä»¥ç»´æŒåŸæœ¬çš„æ ‘å½¢ç»“æ„
    final elementNode = clone();
    //truncatedNodeåœ¨ä¸Šé¢å¾ªç¯çš„æ—¶å€™å·²ç»æ‹¿åˆ°äº†å­èŠ‚ç‚¹layoutæ–¹æ³•è¿”å›å‡ºæ¥çš„åˆ†é¡µèŠ‚ç‚¹äº†
    //æ‰€ä»¥åœ¨è¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨addAllå°†childIndexä»¥åçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ”¾å…¥è¿™ä¸ªtruncatedNodeä¸­
    truncatedNode.addAll(children.skip(childIndex + 1).toList());
    elementNode.children = truncatedNode; //å°†truncatedNodeå½“ä¸ºè¿™ä¸ªæ‹·è´èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
    elementNode.currentOffset = Offset(defaultDx, 0);
    truncatedIndex = childIndex;
    nextPageNode = [elementNode];
  }


  void rearrangement() {
    //è¿™é‡Œæ˜¯åˆ¤æ–­è¿™ä¸ªè¡Œå†…çš„æ‰€æœ‰èŠ‚ç‚¹é«˜åº¦æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒçš„è¯å¯èƒ½ä¼šå‡ºç°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¯”ç¬¬äºŒä¸ªèŠ‚ç‚¹çŸ®ä¸€æˆªçš„æƒ…å†µ
    //æ‰€ä»¥è¿™é‡Œéœ€è¦å°†è¿™æ ·çš„èŠ‚ç‚¹ç»™é‡æ–°ç¼–æ’ä¸€è¾¹
    if (currentLineIndex.isNotEmpty && highlyInconsistent) {
      for (int index in currentLineIndex) {
        ReaderNode child = children[index];
        if (child.currentHeight == currentLineHeight) continue;
        double difference = currentLineHeight - child.currentHeight;
        child.deepUpdateOffset(0, difference);
        children[index] = child;
      }
      currentLineIndex.clear();
      highlyInconsistent = false;
    }
  }

  //é€’å½’ç»˜åˆ¶å­èŠ‚ç‚¹
  @override
  void paint(Canvas canvas, Offset offset) {
    if (children.isNotEmpty) {
      for (ReaderNode child in children) {
        child.paint(canvas, child.currentOffset);
      }
    }
  }
}

```

</details>

## åˆ†é¡µè®¡ç®—

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»å®Œæˆäº† **EPUB æ–‡ä»¶è§£æ**ã€**CSS æ ·å¼è§£æ** ä»¥åŠ **èŠ‚ç‚¹æ ‘çš„ç”Ÿæˆ**ã€‚  
å…¶ä¸­ `ElementNode` è´Ÿè´£ **å¸ƒå±€å¤„ç†**ï¼Œ`TextNode` è´Ÿè´£ **æ–‡æœ¬æ’ç‰ˆ**ï¼Œä½†è¦å®ç°é˜…è¯»å™¨çš„å®Œæ•´ä½“éªŒï¼Œè¿˜éœ€è¦ä¸€ä¸ª **åˆ†é¡µå™¨** æ¥æŠŠæ•´ä¸ªç« èŠ‚æ‹†åˆ†æˆå¯ç¿»é¡µçš„é¡µé¢ã€‚

### PageNodes ç±»

`PageNodes` çš„èŒè´£æ˜¯ï¼š  

- æŒæœ‰ä¸€ä¸ª `List<List<ReaderNode>>`ï¼Œæ¯ä¸ªå­ `List` ä»£è¡¨ä¸€é¡µçš„èŠ‚ç‚¹æ ‘ã€‚  
- é€’å½’è°ƒç”¨å„ä¸ª `ReaderNode` çš„ `layout` æ–¹æ³•ï¼Œå®ç°åˆ†é¡µé€»è¾‘ã€‚  
- è®¡ç®—å¹¶è®°å½•æ€»é¡µæ•°ã€é˜…è¯»è¿›åº¦ã€‚  

æ ¸å¿ƒæµç¨‹ï¼š  

1. éå†ç« èŠ‚èŠ‚ç‚¹æ ‘
2. è°ƒç”¨ `layout` è·å–æ’ç‰ˆç»“æœ  
3. è‹¥èŠ‚ç‚¹è¶…å‡ºå½“å‰é¡µé«˜åº¦ï¼Œåˆ™ç”Ÿæˆ **spillover**ï¼ˆæº¢å‡ºèŠ‚ç‚¹ï¼‰ï¼Œæ”¾å…¥ä¸‹ä¸€é¡µç»§ç»­å¤„ç†  
4. æœ€ç»ˆå¾—åˆ°ä¸€ä¸ª **åˆ†é¡µåçš„èŠ‚ç‚¹æ ‘é›†åˆ**  

```dart
class PageNodes {
  List<List<ReaderNode>> list = [];
  int pageCount = 0;
  int readRecodesIndex;
  double pageHeight;
  double pageWidth;
  bool isColumn;
  int columnNum;
  List<List<ReaderNode>> unallocated;
  int readPage = 0;

  void _paginateChapter(List<ReaderNode> chapterRootNodes) {
    NodeStatus.pageHeight = pageHeight;
    NodeStatus.pageWidth = pageWidth;

    List<ReaderNode> nodesToLayout = List.from(chapterRootNodes);
    while (nodesToLayout.isNotEmpty) {
      final List<ReaderNode> currentPageNodes = [];
      List<ReaderNode> nodesForNextPage = [];
      Offset currentOffset = Offset.zero;

      for (int i = 0; i < nodesToLayout.length; i++) {
        final node = nodesToLayout[i];
        List<ReaderNode> spillover = node.layout(pageWidth, currentOffset);
        currentPageNodes.add(node);
        if (node.hasIndexList.contains(readRecodesIndex)) readPage = list.length + currentPageNodes.length;
        if (spillover.isNotEmpty) {
          nodesForNextPage.addAll(spillover);
          if (i + 1 < nodesToLayout.length) {
            nodesForNextPage.addAll(nodesToLayout.sublist(i + 1));
          }
          break;
        }
        currentOffset = node.nextOffset ?? const Offset(0, 0);
      }

      if (currentPageNodes.isNotEmpty) {
        list.add(currentPageNodes);
      } else if (nodesToLayout.isNotEmpty && nodesForNextPage.isEmpty) {
        nodesForNextPage = List.from(nodesToLayout);
      }
      nodesToLayout = nodesForNextPage;
    }
  }

  void _start() {
    for (var item in unallocated) {
      _paginateChapter(item);
    }
    pageCount = isColumn ? (list.length / columnNum).ceil() : list.length;
    readPage = isColumn ? (readPage / columnNum).ceil() : readPage;
    readPage = max(0, readPage - 1);
  }

  PageNodes(this.unallocated, this.pageWidth, this.pageHeight,
      {this.isColumn = false, this.columnNum = 2, this.readRecodesIndex = 0}) {
    _start();
  }
}
```

## é¡µé¢æ¸²æŸ“

åœ¨å®Œæˆåˆ†é¡µåï¼Œå¾—åˆ°çš„ `PageNodes` æ•°æ®å³å¯ç›´æ¥ç”¨äº é¡µé¢ç»˜åˆ¶ã€‚
è¿™é‡Œä½¿ç”¨ `CustomPainter` å¾ªç¯ç»˜åˆ¶èŠ‚ç‚¹æ ‘ï¼Œè¾¾åˆ°å®Œæ•´çš„é˜…è¯»å™¨æ¸²æŸ“æ•ˆæœï¼š

```dart
class ReaderPainter extends CustomPainter {
  final List<ReaderNode> nodeList;

  ReaderPainter(this.nodeList);

  @override
  void paint(Canvas canvas, Size size) {
    for (ReaderNode node in nodeList) {
      node.paint(canvas, node.currentOffset);
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}
```

## æ€»ç»“ä¸å±•æœ›

è‡³æ­¤ï¼Œä¸€ä¸ªç®€æ˜“ EPUB é˜…è¯»å™¨çš„æ ¸å¿ƒæ¸²æŸ“å¼•æ“å·²ç»æ„å»ºå®Œæˆã€‚æ•´ä¸ªæµç¨‹è‡ªåº•å‘ä¸Šï¼Œå®ç°äº†ä»æ–‡ä»¶è§£æåˆ°æœ€ç»ˆç»˜åˆ¶çš„å®Œæ•´é—­ç¯ã€‚

### æ ¸å¿ƒæ¸²æŸ“æµç¨‹æ€»ç»“

æ¸²æŸ“å¼•æ“çš„å®ç°å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å››ä¸ªå…³é”®æ­¥éª¤ï¼š

1. **è§£æ**ï¼šé¦–å…ˆï¼Œå¯¹ EPUB åŒ…å†…çš„ XHTML å†…å®¹è¿›è¡Œ DOM è§£æï¼ŒåŒæ—¶è§£æ CSS æ ·å¼è¡¨ï¼Œå»ºç«‹èµ·å†…å®¹ä¸æ ·å¼çš„åˆæ­¥æ˜ å°„å…³ç³»ã€‚

2. **èŠ‚ç‚¹æ ‘æ„å»º**ï¼šå°†è§£æåçš„ DOM å’Œ CSS æ•°æ®ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„ã€æ›´é€‚åˆæ¸²æŸ“å’Œæ’ç‰ˆçš„å†…éƒ¨èŠ‚ç‚¹æ ‘ç»“æ„ï¼ˆå¦‚ `ReaderNode`ã€`ElementNode`ã€`TextNode`ï¼‰ã€‚è¿™æ£µæ ‘æ˜¯åç»­æ‰€æœ‰æ“ä½œçš„åŸºç¡€ã€‚

3. **åˆ†é¡µè®¡ç®—**ï¼šè¿™æ˜¯å®ç°é˜…è¯»å™¨ç¿»é¡µä½“éªŒçš„æ ¸å¿ƒã€‚é€šè¿‡éå†èŠ‚ç‚¹æ ‘è°ƒç”¨èŠ‚ç‚¹çš„`layout`æ–¹æ³•å°†èŠ‚ç‚¹åˆ†é…åˆ°ä¸åŒçš„é¡µé¢ï¼ˆ`PageNodes`ï¼‰ï¼Œå®Œæˆå†…å®¹çš„åˆ†é¡µã€‚

4. **ç»˜åˆ¶**ï¼šæœ€åï¼Œåˆ©ç”¨ Flutter çš„ `CustomPaint`ï¼Œå°†è®¡ç®—å¥½çš„é¡µé¢èŠ‚ç‚¹ï¼ˆ`PageNodes`ï¼‰é«˜æ•ˆåœ°ç»˜åˆ¶åˆ°å±å¹•ç”»å¸ƒä¸Šï¼Œæœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·ã€‚

é€šè¿‡ä¸Šè¿°æµç¨‹ï¼Œå†é…åˆ `PageView` ç­‰ç¿»é¡µæ§ä»¶ï¼Œä¸€ä¸ªåŸºç¡€çš„ EPUB é˜…è¯»ä½“éªŒä¾¿å¾—ä»¥å®ç°ã€‚

### å½“å‰å®ç°çš„å±€é™ä¸æœªæ¥å±•æœ›

å°½ç®¡æ ¸å¿ƒåŠŸèƒ½å·²ç»å®Œæˆï¼Œä½†å½“å‰çš„æ¸²æŸ“å™¨ä»å¤„äºæ—©æœŸé˜¶æ®µï¼Œå­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œä¹Ÿä¸ºæœªæ¥çš„è¿­ä»£æŒ‡æ˜äº†æ–¹å‘ï¼š

- **æ ‡ç­¾å…¼å®¹æ€§æœ‰é™**ï¼šç›®å‰ä»…å®ç°äº†å¯¹éƒ¨åˆ†å¸¸ç”¨ HTML æ ‡ç­¾çš„æ”¯æŒã€‚è‹¥è¦å®Œç¾å…¼å®¹æ‰€æœ‰ EPUB æ–‡ä»¶ï¼Œéœ€è¦æŒç»­æ‰©å±•å’Œå®Œå–„å¯¹æ›´å¤šæ ‡ç­¾ï¼ˆå¦‚è¡¨æ ¼ã€å¤æ‚åˆ—è¡¨ã€å¤šåª’ä½“ç­‰ï¼‰çš„è§£æä¸æ¸²æŸ“ã€‚

- **å¯¼èˆªä¸å®šä½æœºåˆ¶**ï¼šå½“å‰çš„é˜…è¯»è¿›åº¦è®°å½•å’Œè·³è½¬åŠŸèƒ½é‡‡ç”¨äº†è¾ƒä¸ºå–å·§çš„ä¸´æ—¶æ–¹æ¡ˆã€‚æœªæ¥å¯ä»¥å‡çº§ä¸ºéµå¾ª EPUB å®˜æ–¹ `CFI (Canonical Fragment Identifier)` è§„èŒƒçš„æ–¹å¼ï¼Œå®ç°æ›´ç²¾å‡†ã€æ›´å…·é€šç”¨æ€§çš„ä¹¦ç­¾å’Œè·³è½¬åŠŸèƒ½ã€‚

- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹äºåŒ…å«å¤§é‡å›¾ç‰‡æˆ–å¤æ‚æ ·å¼çš„ä¹¦ç±ï¼Œåˆ†é¡µè®¡ç®—å’Œç»˜åˆ¶çš„æ€§èƒ½ä»æœ‰æå‡ç©ºé—´ã€‚å¯ä»¥æ¢ç´¢æ›´ä¼˜çš„ç®—æ³•ã€æ‡’åŠ è½½æˆ–ç¼“å­˜ç­–ç•¥æ¥æå‡å¤§å‹ä¹¦ç±çš„åŠ è½½é€Ÿåº¦å’Œç¿»é¡µæµç•…åº¦ã€‚

- **åŠŸèƒ½æ‰©å±•**ï¼šåœ¨ç°æœ‰åŸºç¡€ä¸Šï¼Œæœªæ¥è¿˜å¯ä»¥æ·»åŠ æ›´å¤šé«˜çº§åŠŸèƒ½ï¼Œå¦‚ï¼šå…¨æ–‡æœç´¢ã€æ–‡æœ¬é«˜äº®ä¸ç¬”è®°ã€ä¸»é¢˜åˆ‡æ¢ã€å­—ä½“è®¾ç½®ç­‰ï¼Œä»è€Œæ‰“é€ ä¸€ä¸ªåŠŸèƒ½æ›´å…¨é¢ã€ä½“éªŒæ›´å®Œå–„çš„ EPUB é˜…è¯»å™¨ã€‚

---

æ„Ÿè°¢æ‚¨ä¸€è·¯çœ‹åˆ°è¿™é‡Œï¼Œä»¥ä¸Šå°±æ˜¯æˆ‘æ„å»ºè¿™ä¸ª EPUB é˜…è¯»å™¨æ ¸å¿ƒå¼•æ“çš„å®Œæ•´å¿ƒè·¯å†ç¨‹å’ŒæŠ€æœ¯æ€»ç»“ã€‚è¿™ä¸ªé¡¹ç›®ç›®å‰ä»å¤„äºåˆçº§é˜¶æ®µï¼Œæœ‰è®¸å¤šå¯ä»¥å®Œå–„å’Œæ¢ç´¢çš„åœ°æ–¹ï¼Œå¸Œæœ›æˆ‘çš„åˆ†äº«èƒ½èµ·åˆ°æŠ›ç –å¼•ç‰çš„ä½œç”¨ã€‚æœŸå¾…ä¸æ‚¨åœ¨æœªæ¥çš„å¼€å‘ä¸­è¿›ä¸€æ­¥äº¤æµæ¢è®¨ã€‚
